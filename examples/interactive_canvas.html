<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>Interactive L-Systems</title>
</head>

<body>

	<div class="input">
		<label for="word">Initiator:</label>
		<input id="word" name="word" type="text" value="F">

		<label for="angle">rotation angle (Î´):</label>
		<input id="angleSlider" name="angle" type="range" min="-180.0" max="180.0" value="90.1">
		<input id="angleField" name="angle" type="text" min="-180" max="180" value="90">


		<div class="productions">
			<!-- going to be filled -->
		</div>
		<input class="addBtn" name="newProduction" type="button" value="+">
		<input class="iterateBtn" name="iterate" type="button" value="next iteration">
		<input class="resetIterations" name="resetIterations" type="button" value="reset iteration">

	</div>

	<canvas height="1600" id="canvas" width="1000"></canvas>

</body>

<!-- <script src="../node_modules/babel/node_modules/babel-core/browser-polyfill.min.js" charset="utf-8"></script> -->
<script src="lindenmayer_ES5.js" charset="utf-8"></script>
<script type="text/javascript">
	var drawTimer
	var canvas = document.getElementById('canvas')
	var ctx = canvas.getContext("2d")


	var productionFields = document.querySelector('.productions')
	var addBtn = document.querySelector('.addBtn')
	var iterateBtn = document.querySelector('.iterateBtn')
	var restBtn = document.querySelector('.resetIterations')


	var wordField = document.querySelector('#word')
	var angleSlider = document.querySelector('#angleSlider')
	var angleField = document.querySelector('#angleField')


	var angle
	var change = true



	lsys = new LSystem({
		word: wordField.value,
		finals: [
			['F', () => {
				ctx.beginPath()
				ctx.moveTo(0, 0)
				ctx.lineTo(0, 30 / (lsys.iterations + 1))
				ctx.stroke()
				ctx.translate(0, 30 / (lsys.iterations + 1))
			}],
			['+', () => {
				ctx.rotate((Math.PI / 180) * angle)
			}],
			['-', () => {
				ctx.rotate((Math.PI / 180) * -angle)
			}],
			['[', () => {
				ctx.save()
			}],
			[']', () => {
				ctx.restore()
			}]
		]
	})

	function updateAngle(newAngle) {
		angle = newAngle
		angleField.value = angle
		angleSlider.value = angle
		}

	angleSlider.addEventListener('input', () => {
		window.clearTimeout(drawTimer)
		drawTimer = window.setTimeout(function () {
			updateAngle(angleSlider.value)
			change = true
			//	window.requestAnimationFrame(draw)
		}, 10);
	})


	angleField.addEventListener('input', () => {
		window.clearTimeout(drawTimer)
		drawTimer = window.setTimeout(function () {
			updateAngle(angleSlider.value)
			change = true
			//window.requestAnimationFrame(draw)
		}, 10);
	})

	wordField.addEventListener('keyup', () => {
		window.clearTimeout(drawTimer)
		drawTimer = window.setTimeout(function () {
			lsys.word = wordField.value
			change = true
			fieldsChanged()
		}, 10);

	})


	var productionsFields
	var drawPromise

	function addProductionField() {
		var newProd = document.createElement('div')
		var fromField = document.createElement('input')
		var toField = document.createElement('input')

		newProd.classList.add('production')
		fromField.addEventListener('keyup', (arguments) => {
			window.setTimeout(function () {
				fieldsChanged()
				change = true
			}, 100);
		})
		toField.addEventListener('keyup', (arguments) => {
			window.setTimeout(function () {
				fieldsChanged()
				change = true
			}, 100);
		})


		newProd.appendChild(fromField)
		newProd.appendChild(toField)
		productionFields.appendChild(newProd)
	}

	addBtn.addEventListener('click', addProductionField)
	iterateBtn.addEventListener('click', () => {
		window.setTimeout(function () {
			iterate()
		}, 100);
	})
	restBtn.addEventListener('click', reset)




	function fieldsChanged() {
		// for convenience generate new L-System but create new viz at previous iteration
		// so you can see the changes live... (for smaller complexity)

		var prevIterations = 0
		var prevFinals = []
		if (lsys) {
			prevIterations = lsys.iterations
			if (lsys.finals) prevFinals = lsys.finals
		}

		lsys = new LSystem({
			word: wordField.value,
			finals: prevFinals
		})

		var productions = document.querySelectorAll('.production')

		// first aggregate key value fields and set to lsys' production
		for (var i = 0; i < productions.length; i++) {
			console.log(productions[i].children[0].value, ' => ', productions[i].children[1].value)

			lsys.productions.set(
				productions[i].children[0].value,
				productions[i].children[1].value);
		}

		lsys.iterate(prevIterations)
		//(window.requestAnimationFrame(draw))

	}

	function iterate(n=1) {
		lsys.iterate(n)
		//	window.requestAnimationFrame(draw)
	}




	function draw(timestamp) {
		if (change === true){
		change = false
		console.log('change! so draw');
		ctx.setTransform(1, 0, 0, 1, 0, 0);
		ctx.clearRect(0, 0, canvas.width, canvas.height)
		ctx.translate(300, 300)
		ctx.moveTo(0, 0)
		ctx.rotate((Math.PI / 180) * 180)

		lsys.final()

	}

		window.requestAnimationFrame(draw);




	}

	window.requestAnimationFrame(draw)


	function reset() {
		console.log('reset iterations')
		if (lsys) {
			lsys.word = wordField.value
			window.requestAnimationFrame(draw)
			lsys.iterations = 0
		}
	}
</script>

</html>
