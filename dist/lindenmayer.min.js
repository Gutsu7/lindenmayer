"use strict";function transformClassicStochasticProductions(t){return function(){for(var i=t,s=i.length,r=Math.random(),o=0;o<s;o++){var e=(o+1)/s;if(r<=e)return i[o]}console.error("Should have returned a result of the list, something is wrong here with the random numbers?.")}}function testClassicParametricSyntax(t){return/\(.+\)/.test(t)}function transformClassicParametricAxiom(t){for(var i=t.replace(/\s+/g,"").split(/[\(\)]/),s=[],r=0;r<i.length-1;r+=2){var o=i[r+1].split(",").map(Number);s.push({symbol:i[r],params:o})}}function transformClassicCSProduction(t){var i=t[0].match(/(.+)<(.)/),s=t[0].match(/(.)>(.+)/);if(null===i&&null===s)return t;var r=void 0,o=t[1].successor||t[1].successors?t[1]:{successor:t[1]};return null!==i&&(r=i[2],o.leftCtx=i[1]),null!==s&&(r=s[1],o.rightCtx=s[2]),[r,o]}function stringToObjects(t){if("string"!=typeof t&&t instanceof String==!1)return t;for(var i=[],s=t,r=Array.isArray(s),o=0,s=r?s:s[Symbol.iterator]();;){var e;if(r){if(o>=s.length)break;e=s[o++]}else{if(o=s.next(),o.done)break;e=o.value}var n=e;i.push({symbol:n})}return i}function normalizeProductionRightSide(t,i){if(t.hasOwnProperty("successors"))for(var s=0;s<t.successors.length;s++)t.successors[s]=normalizeProductionRightSide(t.successors[s],i);else t.hasOwnProperty("successor")===!1&&(t={successor:t});return i&&t.hasOwnProperty("successor")&&(t.successor=stringToObjects(t.successor)),t}function normalizeProduction(t,i){return t[1]=normalizeProductionRightSide(t[1],i),t}function LSystem(t){var i=t.axiom,s=void 0===i?"":i,r=t.productions,o=t.finals,e=t.branchSymbols,n=void 0===e?"":e,a=t.ignoredSymbols,c=void 0===a?"":a,h=t.allowClassicSyntax,u=void 0===h||h,l=t.classicParametricSyntax,f=void 0!==l&&l,d=t.forceObjects,m=void 0!==d&&d,v=t.debug,y=void 0!==v&&v;return this.setAxiom=function(t){this.axiom=this.forceObjects?stringToObjects(t):t},this.getRaw=function(){return this.axiom},this.getString=function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return"string"==typeof this.axiom?this.axiom:t===!0?this.axiom.reduce((t,i)=>{if(void 0===i.symbol)throw console.log("found:",i),new Error("L-Systems that use only objects as symbols (eg: {symbol: 'F', params: []}), cant use string symbols (eg. 'F')! Check if you always return objects in your productions and no strings.");return t+i.symbol},""):JSON.stringify(this.axiom)},this.getStringResult=this.getString,this.setProduction=function(t,i){var s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=[t,i];if(void 0===r)throw new Error("no production specified.");if(i.successor&&i.successors)throw new Error('You can not have both a "successor" and a "successors" field in your production!');if(this.allowClassicSyntax===!0&&(r=transformClassicCSProduction(r,this.ignoredSymbols)),r=normalizeProduction(r,this.forceObjects),r[1].isStochastic=void 0!==r[1].successors&&r[1].successors.every(t=>void 0!==t.weight),r[1].isStochastic){r[1].weightSum=0;for(var o=r[1].successors,e=Array.isArray(o),n=0,o=e?o:o[Symbol.iterator]();;){var a;if(e){if(n>=o.length)break;a=o[n++]}else{if(n=o.next(),n.done)break;a=n.value}var c=a;r[1].weightSum+=c.weight}}var h=r[0];if(s===!0&&this.productions.has(h)){var u=this.productions.get(h),l=u.successor,f=u.successors;l&&!f&&(u={successors:[u]}),u.successors.push(r[1]),this.productions.set(h,u)}else this.productions.set(h,r[1])},this.setProductions=function(t){if(void 0===t)throw new Error("no production specified.");this.clearProductions();for(var i=Object.entries(t),s=Array.isArray(i),r=0,i=s?i:i[Symbol.iterator]();;){var o;if(s){if(r>=i.length)break;o=i[r++]}else{if(r=i.next(),r.done)break;o=r.value}var e=o,n=e[0],a=e[1];this.setProduction(n,a,!0)}},this.clearProductions=function(){this.productions=new Map},this.setFinal=function(t,i){var s=[t,i];if(void 0===s)throw new Error("no final specified.");this.finals.set(s[0],s[1])},this.setFinals=function(t){if(void 0===t)throw new Error("no finals specified.");this.finals=new Map;for(var i in t)t.hasOwnProperty(i)&&this.setFinal(i,t[i])},this.getProductionResult=function(t,i,s,r){var o=arguments.length>4&&void 0!==arguments[4]&&arguments[4],e=void 0!==t.leftCtx||void 0!==t.rightCtx,n=void 0!==t.condition,a=!1,h=!0;if(n&&t.condition({index:i,currentAxiom:this.axiom,part:s,params:r})===!1?h=!1:e&&(void 0!==t.leftCtx&&void 0!==t.rightCtx?h=this.match({direction:"left",match:t.leftCtx,index:i,branchSymbols:"[]"}).result&&this.match({direction:"right",match:t.rightCtx,index:i,branchSymbols:"[]",ignoredSymbols:c}).result:void 0!==t.leftCtx?h=this.match({direction:"left",match:t.leftCtx,index:i,branchSymbols:"[]"}).result:void 0!==t.rightCtx&&(h=this.match({direction:"right",match:t.rightCtx,index:i,branchSymbols:"[]"}).result)),h===!1)a=!1;else if(t.successors){var u,l;t.isStochastic&&(l=Math.random()*t.weightSum,u=0);for(var f=t.successors,d=Array.isArray(f),m=0,f=d?f:f[Symbol.iterator]();;){var v;if(d){if(m>=f.length)break;v=f[m++]}else{if(m=f.next(),m.done)break;v=m.value}var y=v;if(!(t.isStochastic&&(u+=y.weight,u<l))){var g=this.getProductionResult(y,i,s,r,!0);if(void 0!==g&&g!==!1){a=g;break}}}}else a="function"==typeof t.successor?t.successor({index:i,currentAxiom:this.axiom,part:s,params:r}):t.successor;return a?a:o?a:s},this.applyProductions=function(){for(var t="string"==typeof this.axiom?"":[],i=0,s=this.axiom,r=Array.isArray(s),o=0,s=r?s:s[Symbol.iterator]();;){var e;if(r){if(o>=s.length)break;e=s[o++]}else{if(o=s.next(),o.done)break;e=o.value}var n=e,a=n.symbol||n,c=n.params||[],h=n;if(this.productions.has(a)){var u=this.productions.get(a);h=this.getProductionResult(u,i,n,c)}"string"==typeof t?t+=h:h instanceof Array?Array.prototype.push.apply(t,h):t.push(h),i++}return this.axiom=t,t},this.iterate=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.iterations=t;for(var i=void 0,s=0;s<t;s++)i=this.applyProductions();return i},this.final=function(t){for(var i=0,s=this.axiom,r=Array.isArray(s),o=0,s=r?s:s[Symbol.iterator]();;){var e;if(r){if(o>=s.length)break;e=s[o++]}else{if(o=s.next(),o.done)break;e=o.value}var n=e,a=n;if("object"==typeof n&&n.symbol&&(a=n.symbol),this.finals.has(a)){var c=this.finals.get(a),h=typeof c;if("function"!==h)throw Error("'"+a+"' has an object for a final function. But it is __not a function__ but a "+h+"!");c({index:i,part:n},t)}i++}},this.match=function(t){var i=t.axiom_,s=t.match,r=t.ignoredSymbols,o=t.branchSymbols,e=t.index,n=t.direction,a=0,c=0;i=i||this.axiom,void 0===o&&(o=void 0!==this.branchSymbols?this.branchSymbols:[]),void 0===r&&(r=void 0!==this.ignoredSymbols?this.ignoredSymbols:[]);var h=[],u=void 0,l=void 0,f=void 0,d=void 0,m=void 0,v=void 0,y=void 0;if("right"===n){if(d=v=1,f=e+1,m=0,y=s.length,o.length>0){var g=o;u=g[0],l=g[1]}}else{if("left"!==n)throw Error(n,"is not a valid direction for matching.");if(d=v=-1,f=e-1,m=s.length-1,y=-1,o.length>0){var b=o;l=b[0],u=b[1]}}for(;f<i.length&&f>=0;f+=d){var x=i[f].symbol||i[f],S=s[m];if(x===S){if((0===a||c>0)&&(x===u?(c++,a++,m+=v):x===l?(c=Math.max(0,c-1),a=Math.max(0,a-1),0===c&&(m+=v)):(h.push(f),m+=v)),m===y)return{result:!0,matchIndices:h}}else if(x===u)a++,c>0&&c++;else if(x===l)a=Math.max(0,a-1),c>0&&(c=Math.max(0,c-1));else if((0===a||c>0&&S!==l)&&r.includes(x)===!1)return{result:!1,matchIndices:h}}return{result:!1,matchIndices:h}},this.ignoredSymbols=c,this.debug=y,this.branchSymbols=n,this.allowClassicSyntax=u,this.classicParametricSyntax=f,this.forceObjects=m,this.setAxiom(s),this.clearProductions(),r&&this.setProductions(r),o&&this.setFinals(o),this}LSystem.transformClassicStochasticProductions=transformClassicStochasticProductions,LSystem.transformClassicCSProduction=transformClassicCSProduction,LSystem.transformClassicParametricAxiom=transformClassicParametricAxiom,LSystem.testClassicParametricSyntax=testClassicParametricSyntax,module.exports=LSystem;